# Handoff 009 — Stage 4 Checklist Review

**Date:** 2026-02-20
**Rotation:** review_stage_transition (stage 3→4)
**Stage:** 4 checklist reviewed and corrected

## What was reviewed

The stage 4 checklist generated by handoff_008 was thoroughly reviewed against the actual codebase. Multiple critical bugs and design issues were found and fixed.

## Critical bugs fixed

### 1. Wrong table name
- **Was:** `sms_messages` (in seed/cleanup SQL)
- **Fixed:** `_ayb_sms_messages` (verified via migration 016)

### 2. Wrong column name for phone
- **Was:** `to` (in seed fixture)
- **Fixed:** `to_phone` (verified via migration 016 and messaging_handler.go)

### 3. Missing FK user_id requirement
- **Was:** `seedSMSMessage` just inserted into messages table
- **Fixed:** Added `ensureSMSTestUser` helper that creates a test user with well-known UUID `00000000-0000-0000-0000-000000000099` via `ON CONFLICT DO NOTHING` upsert before inserting messages. The `_ayb_sms_messages.user_id` has `NOT NULL REFERENCES _ayb_users(id)` constraint.

### 4. SMS Health stats query wrong table
- **Was:** Phase 9 said "seed messages and health stats will update"
- **Fixed:** Health stats come from `_ayb_sms_daily_counts` (separate aggregation table), NOT from `_ayb_sms_messages`. Added `seedSMSDailyCounts` and `cleanupSMSDailyCounts` fixture helpers that INSERT/DELETE from the correct table. The health handler (`sms_health_handler.go:26`) queries `_ayb_sms_daily_counts`, not messages.

### 5. provider_message_id column name documented
- DB column: `provider_message_id` (mapped to JSON `"message_id"`)

## Design issues fixed

### 6. SMSHealth heading — added as explicit Phase 7 Step 0
SMSHealth.tsx has no `<h2>` heading (SMSMessages has one). The old checklist mentioned this in notes but didn't add a step. Now Phase 7 starts with Step 0: add `<h2>SMS Health</h2>` heading + update SMSHealth.test.tsx.

### 7. Removed fragile "empty state" browser test
The old checklist had a smoke test for "No messages sent yet" that it acknowledged might conflict with seeded data from other tests. Removed it — testing empty state in component tests (already done) is sufficient.

### 8. Fixed run commands
- Old: `cd ui && npx playwright test --project=smoke smoke/sms-health.spec.ts`
- Fixed: `cd ui && npx playwright test --project=smoke browser-tests-unmocked/smoke/sms-health.spec.ts`

### 9. Added pendingCleanup pattern to Phase 9
Full tests now follow the `webhooks-lifecycle.spec.ts` pattern with `pendingCleanup` array + `test.afterEach` for reliable cleanup even on test failure.

### 10. Simplified Phase 9 send test
Instead of writing a test with OPTIONS (a-d) and RECOMMENDED approaches, it's now just a `test.skip` with a clear TODO comment.

## DB schema reference (verified)
```
_ayb_sms_messages: id, user_id (FK), to_phone, body, provider, provider_message_id, status, error_message, created_at, updated_at
_ayb_sms_daily_counts: date (PK), count, confirm_count, fail_count
_ayb_users: id, email, password_hash, phone (nullable), created_at, updated_at
```

## Files modified
- `.mike/sms_ui_CHECKLIST-a6070a/checklists/stage_04_checklist.md` — rewritten with all fixes
- `.mike/sms_ui_CHECKLIST-a6070a/state.json` — current_stage: 4, rotation: work

## What's next — Stage 4, Session 1 (build)
Start with Phase 7 Step 0 (add SMSHealth heading), then Step 1 (Layout.tsx integration):
1. Add `<h2>SMS Health</h2>` heading to SMSHealth.tsx + test
2. Update Layout.tsx: View type, imports, sidebar Messaging section, routing
3. Update CommandPalette.tsx: add SMS nav items
4. Update Layout.test.tsx: add mocks + 4 new tests
5. Commit layout integration
6. Then proceed to Phase 8 (browser smoke tests)
